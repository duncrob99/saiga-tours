{% load static %}

<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="{% static 'analytics/js/visibility/visibility.core.js' %}"></script>
<script src="{% static 'analytics/js/visibility/visibility.timers.js' %}"></script>
<script>
    (function () {
        let cookie = document.cookie;
        let csrfToken = cookie.substring(cookie.indexOf('csrftoken=') + 'csrftoken='.length).split(';')[0];
        let reportInterval = 5000;

        let time_visible = 0;
        let became_visible;
        Visibility.onVisible(() => {
            became_visible = new Date().getTime();
        });

        $.ajax({
            type: "POST",
            url: "{% url 'view' %}",
            data: {
                'path': window.location.pathname,
                'interval': reportInterval,
                'referer': "{{ request.META.HTTP_REFERER }}"
            },
            success: data => {
                console.log('success data: ', data);

                Visibility.change((ev, state) => {
                    if (state === 'visible') {
                        became_visible = new Date().getTime();
                    } else {
                        time_visible += new Date().getTime() - became_visible;
                    }
                })

                if (!data.accepted_cookies) {
                    document.querySelector('#cookie-banner').classList.remove('hidden');
                }

                setInterval(() => {
                    if (!Visibility.hidden()) {
                        time_visible += new Date().getTime() - became_visible;
                        became_visible = new Date().getTime();
                    }
                    $.ajax({
                        type: "POST",
                        url: "{% url 'heartbeat' %}",
                        data: {
                            'path': window.location.pathname,
                            'interval': reportInterval,
                            'time_visible': time_visible
                        },
                        success: function () {
                            time_visible = 0;
                        },
                        error: () => {
                            console.log("You're not being tracked anymore");
                        },
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                }, reportInterval)

                window.addEventListener('beforeunload', () => {
                    if (!Visibility.hidden()) {
                        time_visible += new Date().getTime() - became_visible;
                        became_visible = new Date().getTime();
                    }
                    $.ajax({
                        type: "POST",
                        url: "{% url 'close' %}",
                        data: {
                            'path': window.location.pathname,
                            'time_visible': time_visible
                        },
                        success: function () {
                            console.log("You're still being tracked");
                        },
                        error: () => {
                            console.log("You're not being tracked anymore");
                        },
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                })

                let last_pos;
                let distance_trigger = 50;
                window.addEventListener('mousemove', (ev) => {
                    if (last_pos === undefined || Math.sqrt((last_pos.x - ev.x) ** 2 + (last_pos.y - ev.y) ** 2) > distance_trigger) {
                        last_pos = {x: ev.x, y: ev.y};
                        $.ajax({
                            type: "POST",
                            url: "{% url 'mouse-action' %}",
                            data: {
                                'path': window.location.pathname,
                                'x': ev.x,
                                'y': ev.y,
                            },
                            success: function () {
                            },
                            error: () => {
                            },
                            headers: {
                                'X-CSRFToken': csrfToken
                            }
                        })
                    }
                })

                window.addEventListener('mousedown', (ev) => {
                    $.ajax({
                        type: "POST",
                        url: "{% url 'mouse-action' %}",
                        data: {
                            'path': window.location.pathname,
                            'x': ev.x,
                            'y': ev.y,
                            'clicked': ev.button
                        },
                        success: function () {
                        },
                        error: () => {
                        },
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                })
            },
            error: () => {
                console.log("You're not being tracked");
            },
            headers: {
                'X-CSRFToken': csrfToken
            }
        })

    })();
</script>
<div id="analytics-debug"></div>