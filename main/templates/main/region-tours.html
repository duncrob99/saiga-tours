{% extends 'main/main.html' %}
{% load main_tags %}
{% load static %}

{% block title %}
    {{ title }}
{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/map.css' %}">
{% endblock %}

{% block content %}
    {% if countries %}
        {% include 'main/map.html' with destinations=countries %}
    {% endif %}
    {% if countries and region.tour_blurb or countries and tours %}
        <hr>
    {% endif %}
    <h1 class="section-title">{{ title }}</h1>
    {{ region.tour_blurb | delay_images:request }}
    {% if region.tour_blurb and tours %}
        <hr>
    {% endif %}
    {% include 'main/tours_cards.html' %}
{% endblock %}

{% block js %}
    <script defer src="{% static 'js/svg.js' %}"></script>
    <script defer src="{% static 'js/svg.panzoom.min.js' %}"></script>
    <script defer src="{% static 'js/svg.easing.min.js' %}"></script>
    <script defer src="{% static 'js/map.js' %}"></script>
    {% if request.user.is_staff %}
        <script defer src="{% static 'nouislider/nouislider.js' %}"></script>
    {% endif %}
    <script type="module">
        window.destinations = {};
        {% for destination in countries %}
            destinations[{{ destination.pk }}] = {
                name: {{ destination.name | js_str }},
                url: "{% url 'destination' destination.region.slug destination.slug %}",
                form_ix: {{ forloop.counter0 }},
                title_pos: {
                    x: {{ destination.title_x | convert_None }},
                    y: {{ destination.title_y | convert_None }},
                    scale: {{ destination.title_scale | convert_None }},
                    rotation: {{ destination.title_rotation | convert_None }},
                    curve: {{ destination.title_curve | convert_None }}
                }
            };
        {% endfor %}

        window.points = [];
        {% for point in points %}
            points.push({
                x: {% if point.template and point.template.x is not None %}{{ point.template.x }}{% else %}{{ point.x }}{% endif %},
                y: {% if point.template and point.template.y is not None %}{{ point.template.y }}{% else %}{{ point.y }}{% endif %},
                name: "{{ point.name }}",
                radius: {{ point.activation_radius }},
                size: {{ point.size }}
            })
        {% endfor %}

        //window.navbar_height = document.querySelector('.navbar').getBoundingClientRect().height;
        //window.height = (document.documentElement.clientHeight - navbar_height);
        let height = window.outerHeight - document.querySelector('.map').offsetTop;
        console.log(window.outerHeight, document.querySelector('.map').offsetTop, height);
        window.printStats = () => {
            console.log('window.outerHeight', window.outerHeight);
            console.log('document.querySelector(".map").offsetTop', document.querySelector('.map').offsetTop);
            console.log('height', height);
        }
        make_map_work(destinations, undefined, height, undefined, undefined, undefined, points);
    </script>
{% endblock %}
